<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wet Woodland Distribution in England</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #info {
            position: absolute;
            top: 58px;
            left: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 350px;
            font-size: 13px;
            z-index: 1;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
            color: #333;
        }
        #info strong {
            color: #000;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #legend h3 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }
        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right,
                rgb(1, 152, 189),
                rgb(73, 227, 206),
                rgb(216, 254, 181),
                rgb(254, 237, 177),
                rgb(254, 173, 84),
                rgb(209, 55, 78)
            );
            border-radius: 2px;
            margin-bottom: 8px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 250px;
            font-size: 13px;
            z-index: 1;
        }
        #controls h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
            color: #000;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #333;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .slider-value {
            color: #0066cc;
            font-weight: 600;
        }
        #view-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            overflow: hidden;
            z-index: 2;
            font-size: 13px;
        }
        #view-toggle button {
            padding: 10px 18px;
            border: none;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
        }
        #view-toggle button.active {
            background: #0066cc;
            color: white;
        }
        #view-toggle button:not(.active):hover {
            background: #e0e0e0;
        }
        #polygon-popup {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            max-height: 70vh;
            overflow: auto;
            background: white;
            color: #333;
            padding: 16px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
        }
        #polygon-popup.visible {
            display: block;
        }
        #polygon-popup h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: 600;
            color: #000;
        }
        #polygon-popup .attr-row {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }
        #polygon-popup .attr-key {
            color: #666;
        }
        #polygon-popup .attr-val {
            font-weight: 500;
            text-align: right;
        }
        #polygon-popup .close-popup {
            margin-top: 12px;
            padding: 6px 12px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading wet woodland data...</div>

    <div id="view-toggle">
        <button type="button" id="btn-hexagons" class="active">Density</button>
        <button type="button" id="btn-polygons">LNRS Regions</button>
    </div>

    <div id="controls">
        <h3>‚öôÔ∏è Controls</h3>
        <div class="control-group">
            <label>
                <span>Height Exaggeration</span>
                <span class="slider-value" id="height-value">1.3x</span>
            </label>
            <input type="range" id="height-slider" min="10" max="15" value="13" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Opacity</span>
                <span class="slider-value" id="opacity-value">0.50</span>
            </label>
            <input type="range" id="opacity-slider" min="10" max="100" value="50" step="5">
        </div>
        <div class="control-group">
            <label>
                <span>Min Pixels</span>
                <span class="slider-value" id="min-count-value">&gt;1</span>
            </label>
            <input type="range" id="min-count-slider" min="1" max="20" value="1" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Max Pixels</span>
                <span class="slider-value" id="max-count-value">No limit</span>
            </label>
            <input type="range" id="max-count-slider" min="1" max="100" value="100" step="1">
        </div>
    </div>

    <div id="info">
        <h2>üå≤ Wet Woodland Distribution</h2>
        <p style="margin-bottom: 12px; font-size: 12px;">3D hexagon visualization across England</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Coverage Statistics</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Total area:</strong> 181,085 ha (1,811 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Forest cover:</strong> 9.2% of all forest</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>On peat:</strong> 15,876 ha (8.8%)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Off peat:</strong> 165,209 ha (91.2%)</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Patch Distribution</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>‚â§ 0.01 ha:</strong> 8.4% ‚Äî 15,162 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.01-0.1 ha:</strong> 21.8% ‚Äî 39,400 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.1-1 ha:</strong> 37.3% ‚Äî 67,539 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>1-5 ha:</strong> 21.5% ‚Äî 38,932 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>5-10 ha:</strong> 6.0% ‚Äî 10,798 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>‚â• 10 ha:</strong> 5.1% ‚Äî 9,254 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Median:</strong> 0.01 ha | <strong>Largest:</strong> 101.24 ha</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Fragmentation</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Effective Mesh Size:</strong> 2.18 ha (0.02 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Mean NN distance:</strong> 53.2 m</p>
    </div>
    <div id="legend">
        <h3>Wet Woodland Density</h3>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low</span>
            <span>High</span>
        </div>
    </div>

    <div id="polygon-popup">
        <h3 id="polygon-popup-title">Region</h3>
        <div id="polygon-popup-body"></div>
        <button type="button" class="close-popup" id="close-polygon-popup">Close</button>
    </div>

    <script>
        // Initial view state (centered on England)
        const INITIAL_VIEW_STATE = {
            latitude: 52.5,
            longitude: -1.5,
            zoom: 6,
            pitch: 45,
            bearing: 0
        };

        // Control state
        let heightExponent = 1.3;
        let layerOpacity = 0.5;
        let minPixelCount = 1;
        let maxPixelCount = Infinity;
        let viewMode = 'hexagons';  // 'hexagons' | 'polygons'
        let hexagonData = null;
        let polygonData = null;
        let polygonMinDensity = 0;
        let polygonMaxDensity = 1;
        let maxCount = 0;
        let minCount = 0;
        let deckgl = null;

        const DENSITY_COLOR_RANGE = [[1,152,189],[73,227,206],[216,254,181],[254,237,177],[254,173,84],[209,55,78]];

        function densityToColor(value, minVal, maxVal, alpha = 200) {
            const range = maxVal - minVal;
            const normalized = range <= 0 ? 0 : (value - minVal) / range;
            const position = Math.max(0, Math.min(1, normalized)) * (DENSITY_COLOR_RANGE.length - 1);
            const i = Math.floor(position);
            const j = Math.min(i + 1, DENSITY_COLOR_RANGE.length - 1);
            const t = position - i;
            const c = (idx) => Math.floor(DENSITY_COLOR_RANGE[i][idx] + (DENSITY_COLOR_RANGE[j][idx] - DENSITY_COLOR_RANGE[i][idx]) * t);
            return [c(0), c(1), c(2), alpha];
        }

        // Format polygon popup: show key attributes, skip nulls
        function formatPolygonPopup(props) {
            const rows = [];
            const labels = {
                Name: 'Name',
                LNRS_ID: 'LNRS ID',
                Resp_Auth: 'Responsible Authority',
                Status: 'Status',
                total_area_ha: 'Total wet woodland (ha)',
                total_area_km2: 'Total wet woodland (km¬≤)',
                region_area_ha: 'Region area (ha)',
                forest_cover_pct: 'Forest cover %',
                on_peat_ha: 'On peat (ha)',
                off_peat_ha: 'Off peat (ha)',
                on_peat_pct: 'On peat %',
                off_peat_pct: 'Off peat %',
                effective_mesh_size_ha: 'Effective mesh size (ha)',
                mean_nn_m: 'Mean NN distance (m)',
                num_patches: 'Number of patches',
                largest_patch_ha: 'Largest patch (ha)',
                median_patch_ha: 'Median patch (ha)'
            };
            for (const [key, label] of Object.entries(labels)) {
                const v = props[key];
                if (v == null || v === '') continue;
                let text = typeof v === 'number' ? (Number.isInteger(v) ? v.toLocaleString() : v.toFixed(2)) : String(v);
                rows.push({ key: label, val: text });
            }
            return rows;
        }

        function showPolygonPopup(object) {
            if (!object || !object.properties) return;
            const title = object.properties.Name || object.properties.LNRS_ID || 'Region';
            document.getElementById('polygon-popup-title').textContent = title;
            const body = document.getElementById('polygon-popup-body');
            body.innerHTML = formatPolygonPopup(object.properties)
                .map(r => `<div class="attr-row"><span class="attr-key">${r.key}</span><span class="attr-val">${r.val}</span></div>`)
                .join('');
            document.getElementById('polygon-popup').classList.add('visible');
        }

        function hidePolygonPopup() {
            document.getElementById('polygon-popup').classList.remove('visible');
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('btn-hexagons').classList.toggle('active', mode === 'hexagons');
            document.getElementById('btn-polygons').classList.toggle('active', mode === 'polygons');
            document.getElementById('controls').style.display = mode === 'hexagons' ? 'block' : 'none';
            document.getElementById('legend').style.display = 'block';
            document.getElementById('legend').querySelector('h3').textContent = mode === 'hexagons' ? 'Wet Woodland Density' : 'Wet woodland area (ha)';
            document.getElementById('info').style.display = mode === 'hexagons' ? 'block' : 'none';
            if (mode === 'polygons') hidePolygonPopup();
            updateLayers();
        }

        function getLayers() {
            if (viewMode === 'hexagons' && hexagonData) {
                const filteredFeatures = hexagonData.features.filter(f =>
                    f.properties.count > minPixelCount && f.properties.count <= maxPixelCount
                );
                return [new deck.GeoJsonLayer({
                    id: 'wet-woodland-hexagons',
                    data: { type: 'FeatureCollection', features: filteredFeatures },
                    opacity: layerOpacity,
                    stroked: true,
                    filled: true,
                    extruded: true,
                    wireframe: false,
                    lineWidthMinPixels: 0.5,
                    material: { ambient: 0.35, diffuse: 0.6, shininess: 32, specularColor: [60, 60, 60] },
                    getElevation: f => Math.pow(f.properties.count, heightExponent) * 50,
                    getFillColor: f => densityToColor(f.properties.count, minCount, maxCount),
                    getLineColor: [80, 80, 80, 100],
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 100]
                })];
            }
            if (viewMode === 'polygons' && polygonData) {
                return [new deck.GeoJsonLayer({
                    id: 'wet-woodland-lnrs-regions',
                    data: polygonData,
                    stroked: true,
                    filled: true,
                    extruded: false,
                    getFillColor: f => densityToColor(f.properties.total_area_ha ?? 0, polygonMinDensity, polygonMaxDensity, 128),
                    getLineColor: [0, 0, 0, 255],
                    lineWidthMinPixels: 1,
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 80]
                })];
            }
            return [];
        }

        function updateLayers() {
            if (deckgl) deckgl.setProps({ layers: getLayers() });
        }

        // Load hexagon data first, then init map
        fetch('wet_woodland_hexagons.geojson')
            .then(response => response.json())
            .then(data => {
                hexagonData = data;
                const counts = data.features.map(f => f.properties.count);
                maxCount = counts.reduce((a, b) => Math.max(a, b), 0);
                minCount = counts.reduce((a, b) => Math.min(a, b), Infinity);
                document.getElementById('loading').style.display = 'none';

                deckgl = new deck.DeckGL({
                    container: 'map',
                    mapLib: maplibregl,
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: INITIAL_VIEW_STATE,
                    controller: true,
                    layers: getLayers(),
                    effects: [
                        new deck.LightingEffect({
                            ambient: { color: [255, 255, 255], intensity: 1.0 },
                            directional: [
                                { color: [255, 255, 255], intensity: 1.0, direction: [-3, -9, -1] },
                                { color: [255, 255, 255], intensity: 0.5, direction: [1, 3, 8] }
                            ]
                        })
                    ],
                    parameters: { clearColor: [0.07, 0.14, 0.19, 1] },
                    getTooltip: ({ object }) => {
                        if (!object) return null;
                        if (viewMode === 'hexagons' && object.properties.count != null) {
                            const count = object.properties.count;
                            const hectares = (count * 0.01).toFixed(2);
                            return { html: `<div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;"><strong>Wet Woodland:</strong> ${count.toLocaleString()} pixels<br><strong>Area:</strong> ${hectares} ha</div>`, style: { fontSize: '12px', color: 'white' } };
                        }
                        if (viewMode === 'polygons' && object.properties) {
                            const name = object.properties.Name || object.properties.LNRS_ID || 'Region';
                            return { html: `<div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;"><strong>${name}</strong><br>Click for details</div>`, style: { fontSize: '12px', color: 'white' } };
                        }
                        return null;
                    },
                    onClick: ({ object }) => {
                        if (viewMode === 'polygons' && object && object.properties) showPolygonPopup(object);
                    }
                });

                const updateVisualization = () => deckgl.setProps({ layers: getLayers() });

                document.getElementById('height-slider').addEventListener('input', (e) => {
                    heightExponent = parseFloat(e.target.value) / 10;
                    document.getElementById('height-value').textContent = heightExponent.toFixed(1) + 'x';
                    updateVisualization();
                });
                document.getElementById('opacity-slider').addEventListener('input', (e) => {
                    layerOpacity = parseFloat(e.target.value) / 100;
                    document.getElementById('opacity-value').textContent = layerOpacity.toFixed(2);
                    updateVisualization();
                });
                document.getElementById('min-count-slider').addEventListener('input', (e) => {
                    minPixelCount = parseInt(e.target.value);
                    document.getElementById('min-count-value').textContent = '>' + minPixelCount;
                    updateVisualization();
                });
                const maxCountSlider = document.getElementById('max-count-slider');
                const maxCountValue = document.getElementById('max-count-value');
                maxCountSlider.max = maxCount;
                maxCountSlider.value = maxCount;
                maxCountSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    maxPixelCount = value >= maxCount ? Infinity : value;
                    maxCountValue.textContent = maxPixelCount === Infinity ? 'No limit' : '‚â§' + maxPixelCount;
                    updateVisualization();
                });

                document.getElementById('btn-hexagons').addEventListener('click', () => setViewMode('hexagons'));
                document.getElementById('btn-polygons').addEventListener('click', () => {
                    if (polygonData) {
                        setViewMode('polygons');
                    } else {
                        document.getElementById('loading').style.display = 'block';
                        document.getElementById('loading').textContent = 'Loading LNRS regions...';
                        fetch('wet_woodland_lnrs_regions.geojson')
                            .then(r => r.json())
                            .then(geo => {
                                polygonData = geo;
                                const densities = geo.features.map(f => f.properties.total_area_ha ?? 0);
                                polygonMinDensity = densities.length ? Math.min(...densities) : 0;
                                polygonMaxDensity = densities.length ? Math.max(...densities) : 1;
                                if (polygonMaxDensity === polygonMinDensity) polygonMaxDensity = polygonMinDensity + 1;
                                document.getElementById('loading').style.display = 'none';
                                setViewMode('polygons');
                            })
                            .catch(err => {
                                console.error(err);
                                document.getElementById('loading').innerHTML = '‚ùå Error loading regions.';
                            });
                    }
                });
                document.getElementById('close-polygon-popup').addEventListener('click', hidePolygonPopup);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
