<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wet Woodland Distribution in England</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@8.9.36/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 350px;
            font-size: 13px;
            z-index: 1;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
            color: #333;
        }
        #info strong {
            color: #000;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #legend h3 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }
        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right,
                rgb(1, 152, 189),
                rgb(73, 227, 206),
                rgb(216, 254, 181),
                rgb(254, 237, 177),
                rgb(254, 173, 84),
                rgb(209, 55, 78)
            );
            border-radius: 2px;
            margin-bottom: 8px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 250px;
            font-size: 13px;
            z-index: 1;
        }
        #controls h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
            color: #000;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #333;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .slider-value {
            color: #0066cc;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading wet woodland data...</div>

    <div id="controls">
        <h3>‚öôÔ∏è Controls</h3>
        <div class="control-group">
            <label>
                <span>Height Exaggeration</span>
                <span class="slider-value" id="height-value">1.3x</span>
            </label>
            <input type="range" id="height-slider" min="10" max="15" value="13" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Opacity</span>
                <span class="slider-value" id="opacity-value">0.50</span>
            </label>
            <input type="range" id="opacity-slider" min="10" max="100" value="50" step="5">
        </div>
        <div class="control-group">
            <label>
                <span>Min Pixels</span>
                <span class="slider-value" id="min-count-value">&gt;1</span>
            </label>
            <input type="range" id="min-count-slider" min="1" max="20" value="1" step="1">
        </div>
    </div>

    <div id="info">
        <h2>üå≤ Wet Woodland Distribution</h2>
        <p style="margin-bottom: 12px; font-size: 12px;">3D hexagon visualization across England</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Coverage Statistics</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Total area:</strong> 181,085 ha (1,811 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Forest cover:</strong> 9.2% of all forest</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>On peat:</strong> 15,876 ha (8.8%)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Off peat:</strong> 165,209 ha (91.2%)</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Patch Distribution</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>&lt; 0.1 ha:</strong> 90.17% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.1-1 ha:</strong> 9.05% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>1-10 ha:</strong> 0.76% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>‚â• 10 ha:</strong> 0.02% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Median size:</strong> 0.01 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Largest:</strong> 101.24 ha</p>
    </div>
    <div id="legend">
        <h3>Wet Woodland Density</h3>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low</span>
            <span>High</span>
        </div>
    </div>

    <script>
        // Initial view state (centered on England)
        const INITIAL_VIEW_STATE = {
            latitude: 52.5,
            longitude: -1.5,
            zoom: 6,
            pitch: 45,
            bearing: 0
        };

        // Control state (now controls exponent, not multiplier)
        let heightExponent = 1.3;  // Power law exponent (1.0 = linear, 1.5 = dramatic)
        let layerOpacity = 0.5;
        let minPixelCount = 1;  // Minimum pixel count threshold

        // Load data and create visualization
        fetch('wet_woodland_hexagons.geojson')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';

                // Calculate statistics for color scale
                const counts = data.features.map(f => f.properties.count);
                const maxCount = counts.reduce((a, b) => Math.max(a, b), 0);
                const minCount = counts.reduce((a, b) => Math.min(a, b), Infinity);

                console.log(`Loaded ${data.features.length} hexagons`);
                console.log(`Count range: ${minCount} - ${maxCount}`);

                // Function to create/update the hexagon layer
                const createHexagonLayer = () => {
                    // Filter data based on minimum pixel count
                    const filteredFeatures = data.features.filter(f => f.properties.count > minPixelCount);

                    return new deck.GeoJsonLayer({
                        id: `wet-woodland-hexagons-${Date.now()}`,
                        data: {type: 'FeatureCollection', features: filteredFeatures},
                        opacity: layerOpacity,
                        stroked: true,
                        filled: true,
                        extruded: true,
                        wireframe: false,
                        lineWidthMinPixels: 0.5,
                        material: {
                            ambient: 0.35,
                            diffuse: 0.6,
                            shininess: 32,
                            specularColor: [60, 60, 60]
                        },
                        getElevation: f => {
                            const count = f.properties.count;
                            return Math.pow(count, heightExponent) * 50;
                        },
                        getFillColor: f => {
                            const count = f.properties.count;
                            const normalized = (count - minCount) / (maxCount - minCount);
                            const colorRange = [
                                [1, 152, 189],
                                [73, 227, 206],
                                [216, 254, 181],
                                [254, 237, 177],
                                [254, 173, 84],
                                [209, 55, 78]
                            ];
                            const position = normalized * (colorRange.length - 1);
                            const lowerIndex = Math.floor(position);
                            const upperIndex = Math.min(lowerIndex + 1, colorRange.length - 1);
                            const t = position - lowerIndex;
                            const lowerColor = colorRange[lowerIndex];
                            const upperColor = colorRange[upperIndex];
                            const r = Math.floor(lowerColor[0] + (upperColor[0] - lowerColor[0]) * t);
                            const g = Math.floor(lowerColor[1] + (upperColor[1] - lowerColor[1]) * t);
                            const b = Math.floor(lowerColor[2] + (upperColor[2] - lowerColor[2]) * t);
                            return [r, g, b, 200];
                        },
                        getLineColor: [80, 80, 80, 100],
                        pickable: true,
                        autoHighlight: true,
                        highlightColor: [255, 255, 255, 100]
                    });
                };

                // Create deck.gl instance with enhanced effects
                let deckgl = new deck.DeckGL({
                    container: 'map',
                    mapLib: maplibregl,
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: INITIAL_VIEW_STATE,
                    controller: true,
                    layers: [createHexagonLayer()],

                    // Enhanced lighting for better 3D appearance
                    effects: [
                        new deck.LightingEffect({
                            ambient: {
                                color: [255, 255, 255],
                                intensity: 1.0
                            },
                            directional: [
                                {
                                    color: [255, 255, 255],
                                    intensity: 1.0,
                                    direction: [-3, -9, -1]
                                },
                                {
                                    color: [255, 255, 255],
                                    intensity: 0.5,
                                    direction: [1, 3, 8]
                                }
                            ]
                        })
                    ],

                    // Anti-aliasing for smoother edges
                    parameters: {
                        clearColor: [0.07, 0.14, 0.19, 1]
                    },

                    // Tooltip
                    getTooltip: ({object}) => {
                        if (!object) return null;
                        return {
                            html: `
                                <div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;">
                                    <strong>Wet Woodland Pixels:</strong> ${object.properties.count.toLocaleString()}<br>
                                    <strong>H3 Index:</strong> ${object.properties.h3_index}
                                </div>
                            `,
                            style: {
                                fontSize: '12px',
                                color: 'white'
                            }
                        };
                    }
                });

                // Update function for controls
                const updateVisualization = () => {
                    deckgl.setProps({
                        layers: [createHexagonLayer()]
                    });
                };

                // Height slider event handler (controls power law exponent)
                const heightSlider = document.getElementById('height-slider');
                const heightValue = document.getElementById('height-value');
                heightSlider.addEventListener('input', (e) => {
                    heightExponent = parseFloat(e.target.value) / 10;
                    heightValue.textContent = heightExponent.toFixed(1) + 'x';
                    updateVisualization();
                });

                // Opacity slider event handler
                const opacitySlider = document.getElementById('opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                opacitySlider.addEventListener('input', (e) => {
                    layerOpacity = parseFloat(e.target.value) / 100;
                    opacityValue.textContent = layerOpacity.toFixed(2);
                    updateVisualization();
                });

                // Min pixel count slider event handler
                const minCountSlider = document.getElementById('min-count-slider');
                const minCountValue = document.getElementById('min-count-value');
                minCountSlider.addEventListener('input', (e) => {
                    minPixelCount = parseInt(e.target.value);
                    minCountValue.textContent = '>' + minPixelCount;
                    updateVisualization();
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML =
                    '‚ùå Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
