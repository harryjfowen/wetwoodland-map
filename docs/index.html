<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wet Woodland Distribution in England</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 350px;
            font-size: 13px;
            z-index: 1;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
            color: #333;
        }
        #info strong {
            color: #000;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #legend h3 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }
        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right,
                rgb(1, 152, 189),
                rgb(73, 227, 206),
                rgb(216, 254, 181),
                rgb(254, 237, 177),
                rgb(254, 173, 84),
                rgb(209, 55, 78)
            );
            border-radius: 2px;
            margin-bottom: 8px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 250px;
            font-size: 13px;
            z-index: 1;
        }
        #controls h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
            color: #000;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #333;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .slider-value {
            color: #0066cc;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading wet woodland data...</div>

    <div id="controls">
        <h3>‚öôÔ∏è Controls</h3>
        <div class="control-group">
            <label>
                <span>Height Exaggeration</span>
                <span class="slider-value" id="height-value">1.3x</span>
            </label>
            <input type="range" id="height-slider" min="10" max="15" value="13" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Opacity</span>
                <span class="slider-value" id="opacity-value">0.50</span>
            </label>
            <input type="range" id="opacity-slider" min="10" max="100" value="50" step="5">
        </div>
    </div>

    <div id="info">
        <h2>üå≤ Wet Woodland Distribution</h2>
        <p style="margin-bottom: 12px; font-size: 12px;">3D hexagon visualization across England</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Coverage Statistics</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Total area:</strong> 177,009 ha (1,770 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Forest cover:</strong> 9.1% of all forest</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>On peat:</strong> 14,905 ha (8.4%)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Off peat:</strong> 162,104 ha (91.6%)</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Patch Distribution</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>&lt; 0.1 ha:</strong> 90.2% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.1-1 ha:</strong> 9.0% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>1-10 ha:</strong> 0.8% of patches</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Median size:</strong> 0.01 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Largest:</strong> 101.24 ha</p>
    </div>
    <div id="legend">
        <h3>Wet Woodland Density</h3>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low</span>
            <span>High</span>
        </div>
    </div>

    <script>
        // Initial view state (centered on England)
        const INITIAL_VIEW_STATE = {
            latitude: 52.5,
            longitude: -1.5,
            zoom: 6,
            pitch: 45,
            bearing: 0
        };

        // Control state (now controls exponent, not multiplier)
        let heightExponent = 1.3;  // Power law exponent (1.0 = linear, 1.5 = dramatic)
        let layerOpacity = 0.5;

        // Store rivers data globally
        let riversData = null;

        // Load data and create visualization
        Promise.all([
            fetch('wet_woodland_hexagons.geojson').then(r => r.json()),
            fetch('rivers.geojson').then(r => r.json())
        ])
            .then(([data, rivers]) => {
                riversData = rivers;
                document.getElementById('loading').style.display = 'none';

                // Calculate statistics for color scale
                const counts = data.features.map(f => f.properties.count);
                const maxCount = Math.max(...counts);
                const minCount = Math.min(...counts);

                console.log(`Loaded ${data.features.length} hexagons`);
                console.log(`Count range: ${minCount} - ${maxCount}`);

                // Function to create/update the hexagon layer
                const createHexagonLayer = () => new deck.GeoJsonLayer({
                    id: `wet-woodland-hexagons-${Date.now()}`,
                    data: data,
                    opacity: layerOpacity,
                    stroked: true,
                    filled: true,
                    extruded: true,
                    wireframe: false,  // Smoother appearance without grid lines
                    lineWidthMinPixels: 0.5,

                    // Enhanced material properties for better lighting
                    material: {
                        ambient: 0.35,
                        diffuse: 0.6,
                        shininess: 32,
                        specularColor: [60, 60, 60]
                    },

                    // Extrusion height based on count (with adjustable power scaling)
                    getElevation: f => {
                        const count = f.properties.count;
                        // Power scaling with adjustable exponent (1.0 = linear, 2.5 = very dramatic)
                        return Math.pow(count, heightExponent) * 50;
                    },

                    // Color based on count (deck.gl 3d-heatmap color scheme)
                    getFillColor: f => {
                        const count = f.properties.count;
                        const normalized = (count - minCount) / (maxCount - minCount);

                        // 6-color gradient from deck.gl example
                        const colorRange = [
                            [1, 152, 189],      // Cyan-blue
                            [73, 227, 206],     // Turquoise
                            [216, 254, 181],    // Light yellow-green
                            [254, 237, 177],    // Pale yellow
                            [254, 173, 84],     // Orange
                            [209, 55, 78]       // Dark red
                        ];

                        // Interpolate between colors
                        const position = normalized * (colorRange.length - 1);
                        const lowerIndex = Math.floor(position);
                        const upperIndex = Math.min(lowerIndex + 1, colorRange.length - 1);
                        const t = position - lowerIndex;

                        const lowerColor = colorRange[lowerIndex];
                        const upperColor = colorRange[upperIndex];

                        const r = Math.floor(lowerColor[0] + (upperColor[0] - lowerColor[0]) * t);
                        const g = Math.floor(lowerColor[1] + (upperColor[1] - lowerColor[1]) * t);
                        const b = Math.floor(lowerColor[2] + (upperColor[2] - lowerColor[2]) * t);

                        return [r, g, b, 200];
                    },

                    getLineColor: [80, 80, 80, 100],  // Subtle dark outlines

                    // Tooltip
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 100]
                });

                // Function to create the rivers layer
                const createRiversLayer = () => new deck.GeoJsonLayer({
                    id: 'rivers',
                    data: riversData,
                    stroked: true,
                    filled: false,
                    lineWidthMinPixels: 1,
                    lineWidthScale: 20,
                    getLineColor: [255, 50, 50, 255],  // Bright red
                    getLineWidth: 2,
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 100, 200]
                });

                // Create deck.gl instance with enhanced effects
                let deckgl = new deck.DeckGL({
                    container: 'map',
                    mapLib: maplibregl,
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: INITIAL_VIEW_STATE,
                    controller: true,
                    layers: [createHexagonLayer(), createRiversLayer()],

                    // Enhanced lighting for better 3D appearance
                    effects: [
                        new deck.LightingEffect({
                            ambient: {
                                color: [255, 255, 255],
                                intensity: 1.0
                            },
                            directional: [
                                {
                                    color: [255, 255, 255],
                                    intensity: 1.0,
                                    direction: [-3, -9, -1]
                                },
                                {
                                    color: [255, 255, 255],
                                    intensity: 0.5,
                                    direction: [1, 3, 8]
                                }
                            ]
                        })
                    ],

                    // Anti-aliasing for smoother edges
                    parameters: {
                        clearColor: [0.07, 0.14, 0.19, 1]
                    },

                    // Tooltip
                    getTooltip: ({object}) => {
                        if (!object) return null;
                        return {
                            html: `
                                <div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;">
                                    <strong>Wet Woodland Pixels:</strong> ${object.properties.count.toLocaleString()}<br>
                                    <strong>H3 Index:</strong> ${object.properties.h3_index}
                                </div>
                            `,
                            style: {
                                fontSize: '12px',
                                color: 'white'
                            }
                        };
                    }
                });

                // Update function for controls
                const updateVisualization = () => {
                    deckgl.setProps({
                        layers: [createHexagonLayer(), createRiversLayer()]
                    });
                };

                // Height slider event handler (controls power law exponent)
                const heightSlider = document.getElementById('height-slider');
                const heightValue = document.getElementById('height-value');
                heightSlider.addEventListener('input', (e) => {
                    heightExponent = parseFloat(e.target.value) / 10;
                    heightValue.textContent = heightExponent.toFixed(1) + 'x';
                    updateVisualization();
                });

                // Opacity slider event handler
                const opacitySlider = document.getElementById('opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                opacitySlider.addEventListener('input', (e) => {
                    layerOpacity = parseFloat(e.target.value) / 100;
                    opacityValue.textContent = layerOpacity.toFixed(2);
                    updateVisualization();
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML =
                    '‚ùå Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
