<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wet Woodland Distribution in England</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 350px;
            font-size: 14px;
            z-index: 1;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #4CAF50;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1;
        }
        #legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 30px;
            height: 15px;
            margin-right: 10px;
            border-radius: 2px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            width: 250px;
            font-size: 14px;
            z-index: 1;
        }
        #controls h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #4CAF50;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .slider-value {
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading wet woodland data...</div>

    <div id="controls">
        <h3>‚öôÔ∏è Controls</h3>
        <div class="control-group">
            <label>
                <span>Height Exaggeration</span>
                <span class="slider-value" id="height-value">1.0x</span>
            </label>
            <input type="range" id="height-slider" min="10" max="100" value="10" step="5">
        </div>
        <div class="control-group">
            <label>
                <span>Opacity</span>
                <span class="slider-value" id="opacity-value">0.9</span>
            </label>
            <input type="range" id="opacity-slider" min="50" max="100" value="90" step="5">
        </div>
    </div>

    <div id="info">
        <h2>üå≤ Wet Woodland Distribution</h2>
        <p>3D hexagon visualization showing wet woodland density across England</p>
        <p><strong>Height:</strong> Number of wet woodland pixels per hexagon</p>
        <p><strong>Color:</strong> Cyan ‚Üí Turquoise ‚Üí Yellow ‚Üí Orange ‚Üí Red gradient</p>
        <p><strong>Controls:</strong> Drag to rotate, scroll to zoom, right-click drag to pan</p>
    </div>
    <div id="legend">
        <h3>Wet Woodland Density</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(1, 152, 189);"></div>
            <span>Very Low</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(73, 227, 206);"></div>
            <span>Low</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(216, 254, 181);"></div>
            <span>Medium</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(254, 237, 177);"></div>
            <span>Medium-High</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(254, 173, 84);"></div>
            <span>High</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgb(209, 55, 78);"></div>
            <span>Very High</span>
        </div>
    </div>

    <script>
        // Initial view state (centered on England)
        const INITIAL_VIEW_STATE = {
            latitude: 52.5,
            longitude: -1.5,
            zoom: 6,
            pitch: 45,
            bearing: 0
        };

        // Control state
        let heightMultiplier = 1.0;
        let layerOpacity = 0.9;

        // Load data and create visualization
        fetch('wet_woodland_hexagons.geojson')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';

                // Calculate statistics for color scale
                const counts = data.features.map(f => f.properties.count);
                const maxCount = Math.max(...counts);
                const minCount = Math.min(...counts);

                console.log(`Loaded ${data.features.length} hexagons`);
                console.log(`Count range: ${minCount} - ${maxCount}`);

                // Function to create/update the hexagon layer
                const createHexagonLayer = () => new deck.GeoJsonLayer({
                    id: 'wet-woodland-hexagons',
                    data: data,
                    opacity: layerOpacity,
                    stroked: true,
                    filled: true,
                    extruded: true,
                    wireframe: false,  // Smoother appearance without grid lines
                    lineWidthMinPixels: 0.5,

                    // Enhanced material properties for better lighting
                    material: {
                        ambient: 0.35,
                        diffuse: 0.6,
                        shininess: 32,
                        specularColor: [60, 60, 60]
                    },

                    // Extrusion height based on count (with power scaling and multiplier)
                    getElevation: f => {
                        const count = f.properties.count;
                        // Power scaling with adjustable multiplier
                        return Math.pow(count, 1.5) * 50 * heightMultiplier;
                    },

                    // Color based on count (deck.gl 3d-heatmap color scheme)
                    getFillColor: f => {
                        const count = f.properties.count;
                        const normalized = (count - minCount) / (maxCount - minCount);

                        // 6-color gradient from deck.gl example
                        const colorRange = [
                            [1, 152, 189],      // Cyan-blue
                            [73, 227, 206],     // Turquoise
                            [216, 254, 181],    // Light yellow-green
                            [254, 237, 177],    // Pale yellow
                            [254, 173, 84],     // Orange
                            [209, 55, 78]       // Dark red
                        ];

                        // Interpolate between colors
                        const position = normalized * (colorRange.length - 1);
                        const lowerIndex = Math.floor(position);
                        const upperIndex = Math.min(lowerIndex + 1, colorRange.length - 1);
                        const t = position - lowerIndex;

                        const lowerColor = colorRange[lowerIndex];
                        const upperColor = colorRange[upperIndex];

                        const r = Math.floor(lowerColor[0] + (upperColor[0] - lowerColor[0]) * t);
                        const g = Math.floor(lowerColor[1] + (upperColor[1] - lowerColor[1]) * t);
                        const b = Math.floor(lowerColor[2] + (upperColor[2] - lowerColor[2]) * t);

                        return [r, g, b, 200];
                    },

                    getLineColor: [80, 80, 80, 100],  // Subtle dark outlines

                    // Tooltip
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 100]
                });

                // Create deck.gl instance with enhanced effects
                let deckgl = new deck.DeckGL({
                    container: 'map',
                    mapLib: maplibregl,
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: INITIAL_VIEW_STATE,
                    controller: true,
                    layers: [createHexagonLayer()],

                    // Enhanced lighting for better 3D appearance
                    effects: [
                        new deck.LightingEffect({
                            ambient: {
                                color: [255, 255, 255],
                                intensity: 1.0
                            },
                            directional: [
                                {
                                    color: [255, 255, 255],
                                    intensity: 1.0,
                                    direction: [-3, -9, -1]
                                },
                                {
                                    color: [255, 255, 255],
                                    intensity: 0.5,
                                    direction: [1, 3, 8]
                                }
                            ]
                        })
                    ],

                    // Anti-aliasing for smoother edges
                    parameters: {
                        clearColor: [0.07, 0.14, 0.19, 1]
                    },

                    // Tooltip
                    getTooltip: ({object}) => {
                        if (!object) return null;
                        return {
                            html: `
                                <div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;">
                                    <strong>Wet Woodland Pixels:</strong> ${object.properties.count.toLocaleString()}<br>
                                    <strong>H3 Index:</strong> ${object.properties.h3_index}
                                </div>
                            `,
                            style: {
                                fontSize: '12px',
                                color: 'white'
                            }
                        };
                    }
                });

                // Update function for controls
                const updateVisualization = () => {
                    deckgl.setProps({
                        layers: [createHexagonLayer()]
                    });
                };

                // Height slider event handler
                const heightSlider = document.getElementById('height-slider');
                const heightValue = document.getElementById('height-value');
                heightSlider.addEventListener('input', (e) => {
                    heightMultiplier = parseFloat(e.target.value) / 10;
                    heightValue.textContent = heightMultiplier.toFixed(1) + 'x';
                    updateVisualization();
                });

                // Opacity slider event handler
                const opacitySlider = document.getElementById('opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                opacitySlider.addEventListener('input', (e) => {
                    layerOpacity = parseFloat(e.target.value) / 100;
                    opacityValue.textContent = layerOpacity.toFixed(2);
                    updateVisualization();
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML =
                    '‚ùå Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
