<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wet Woodland Distribution in England</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/aggregation-layers@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #info {
            position: absolute;
            top: 58px;
            left: 20px;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 350px;
            font-size: 13px;
            z-index: 1;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
            color: #333;
        }
        #info strong {
            color: #000;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #legend h3 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }
        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right,
                rgb(1, 152, 189),
                rgb(73, 227, 206),
                rgb(216, 254, 181),
                rgb(254, 237, 177),
                rgb(254, 173, 84),
                rgb(209, 55, 78)
            );
            border-radius: 2px;
            margin-bottom: 8px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        .landvalue-toggle {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .landvalue-label {
            font-size: 11px;
            color: #333;
            margin-right: 4px;
        }
        .landvalue-toggle button {
            padding: 4px 10px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            color: #333;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
        }
        .landvalue-toggle button.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        .landvalue-toggle button:not(.active):hover {
            background: #e8e8e8;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 12px 14px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 200px;
            font-size: 12px;
            z-index: 1;
        }
        #controls h3 {
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }
        .control-group {
            margin-bottom: 12px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
            color: #333;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .slider-value {
            color: #0066cc;
            font-weight: 600;
        }
        #view-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            overflow: hidden;
            z-index: 2;
            font-size: 13px;
        }
        #view-toggle button {
            padding: 10px 18px;
            border: none;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
        }
        #view-toggle button.active {
            background: #0066cc;
            color: white;
        }
        #view-toggle button:not(.active):hover {
            background: #e0e0e0;
        }
        #polygon-popup {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            max-height: 70vh;
            overflow: auto;
            background: white;
            color: #333;
            padding: 16px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1;
        }
        #polygon-popup.visible {
            display: block;
        }
        #polygon-popup h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: 600;
            color: #000;
        }
        #polygon-popup .attr-row {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }
        #polygon-popup .attr-key {
            color: #000;
            font-weight: 600;
        }
        #polygon-popup .popup-section-divider {
            margin: 14px 0 10px 0;
            border: none;
            border-top: 1px solid #ccc;
        }
        #polygon-popup .polygon-popup-section {
            margin: 10px 0 4px 0;
            font-weight: 600;
            font-size: 13px;
            color: #000;
        }
        #polygon-popup .attr-val {
            font-weight: 500;
            text-align: right;
        }
        #polygon-popup .close-popup {
            margin-top: 12px;
            padding: 6px 12px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading wet woodland data...</div>

    <div id="view-toggle">
        <button type="button" id="btn-hexagons" class="active">Density</button>
        <button type="button" id="btn-polygons">LNRS Regions</button>
        <button type="button" id="btn-potential">Potential</button>
    </div>

    <div id="controls">
        <h3>‚öôÔ∏è Controls</h3>
        <div class="control-group">
            <label>
                <span>Height Exaggeration</span>
                <span class="slider-value" id="height-value">1.0x</span>
            </label>
            <input type="range" id="height-slider" min="10" max="15" value="10" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Opacity</span>
                <span class="slider-value" id="opacity-value">0.50</span>
            </label>
            <input type="range" id="opacity-slider" min="10" max="100" value="50" step="5">
        </div>
        <div class="control-group">
            <label>
                <span>Min Pixels</span>
                <span class="slider-value" id="min-count-value">&gt;1</span>
            </label>
            <input type="range" id="min-count-slider" min="1" max="20" value="1" step="1">
        </div>
        <div class="control-group">
            <label>
                <span>Max Pixels</span>
                <span class="slider-value" id="max-count-value">No limit</span>
            </label>
            <input type="range" id="max-count-slider" min="1" max="100" value="100" step="1">
        </div>
    </div>

    <div id="info">
        <h2>üå≤ Wet Woodland Distribution</h2>
        <p style="margin-bottom: 12px; font-size: 12px;">3D hexagon visualization across England</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Coverage Statistics</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Total area:</strong> 83,148 ha (831 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Wet woodland:</strong> 5.1% of total forest cover</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>On peat:</strong> 7,265 ha (8.7%)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Off peat:</strong> 75,883 ha (91.3%)</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Patch Distribution</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>‚â§ 0.01 ha:</strong> 0.0% ‚Äî 0 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.01-0.1 ha:</strong> 22.6% ‚Äî 18,765 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>0.1-1 ha:</strong> 50.9% ‚Äî 42,345 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>1-5 ha:</strong> 20.2% ‚Äî 16,755 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>5-10 ha:</strong> 3.9% ‚Äî 3,216 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>‚â• 10 ha:</strong> 2.5% ‚Äî 2,068 ha</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Patches:</strong> 564,505 | <strong>Median:</strong> 0.06 ha | <strong>Mean:</strong> 0.15 ha</p>

        <p style="margin: 8px 0 4px 0; font-weight: 600; font-size: 13px;">Fragmentation</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Effective Mesh Size:</strong> 1.42 ha (0.01 km¬≤)</p>
        <p style="margin: 3px 0; font-size: 12px;"><strong>Mean NN distance:</strong> 136.4 m</p>
    </div>
    <div id="legend">
        <h3 id="legend-title">Wet Woodland Density</h3>
        <div id="landvalue-toggle" class="landvalue-toggle" style="display: none;">
            <span class="landvalue-label">Land value:</span>
            <button type="button" id="lv-12" class="active">1‚Äì2</button>
            <button type="button" id="lv-3">3</button>
            <button type="button" id="lv-45">4‚Äì5</button>
        </div>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>Low</span>
            <span>High</span>
        </div>
    </div>

    <div id="polygon-popup">
        <h3 id="polygon-popup-title">Region</h3>
        <div id="polygon-popup-body"></div>
        <button type="button" class="close-popup" id="close-polygon-popup">Close</button>
    </div>

    <script>
        // Initial view state (centered on England)
        const INITIAL_VIEW_STATE = {
            latitude: 52.5,
            longitude: -1.5,
            zoom: 6,
            pitch: 45,
            bearing: 0
        };

        // Control state
        let heightExponent = 1.0;
        let layerOpacity = 0.5;
        let minPixelCount = 1;
        let maxPixelCount = Infinity;
        let viewMode = 'hexagons';  // 'hexagons' | 'polygons' | 'potential'
        let hexagonData = null;
        let polygonData = null;
        let potentialPoints = null;  // [lon, lat, value] or [lon, lat, value, landClass] for HeatmapLayer
        let potentialLandValueClass = 0;  // 0=1-2, 1=3, 2=4-5 (only used when points have 4 elements)
        let polygonMinDensity = 0;
        let polygonMaxDensity = 1;
        let maxCount = 0;
        let minCount = 0;
        let deckgl = null;

        const DENSITY_COLOR_RANGE = [[1,152,189],[73,227,206],[216,254,181],[254,237,177],[254,173,84],[209,55,78]];

        function densityToColor(value, minVal, maxVal, alpha = 200) {
            const range = maxVal - minVal;
            const normalized = range <= 0 ? 0 : (value - minVal) / range;
            const position = Math.max(0, Math.min(1, normalized)) * (DENSITY_COLOR_RANGE.length - 1);
            const i = Math.floor(position);
            const j = Math.min(i + 1, DENSITY_COLOR_RANGE.length - 1);
            const t = position - i;
            const c = (idx) => Math.floor(DENSITY_COLOR_RANGE[i][idx] + (DENSITY_COLOR_RANGE[j][idx] - DENSITY_COLOR_RANGE[i][idx]) * t);
            return [c(0), c(1), c(2), alpha];
        }

        // Format polygon popup: selected stats only, bold label on left like density info pane
        function formatPolygonPopup(props) {
            const fmt = (v) => v == null || v === '' ? null : (typeof v === 'number' ? (Number.isInteger(v) ? v.toLocaleString() : v.toFixed(2)) : String(v));
            const pctFmt = (v) => v != null && v !== '' ? (typeof v === 'number' ? v.toFixed(1) : String(v)) : null;
            const rows = [];
            const ha = props.total_area_ha;
            const regionHa = props.region_area_ha;
            const pctOfRegion = (ha != null && regionHa != null && regionHa > 0) ? ((ha / regionHa) * 100).toFixed(2) + '%' : null;
            if (fmt(props.LNRS_ID)) rows.push({ key: 'LNRS ID', val: fmt(props.LNRS_ID) });
            if (fmt(props.Resp_Auth)) rows.push({ key: 'Responsible Authority', val: fmt(props.Resp_Auth) });
            if (fmt(ha)) rows.push({ key: 'Total wet woodland (ha)', val: fmt(ha) });
            if (pctOfRegion) rows.push({ key: 'Wet woodland % of region', val: pctOfRegion });
            if (fmt(props.forest_cover_pct)) rows.push({ key: 'Forest cover %', val: fmt(props.forest_cover_pct) });
            if (fmt(props.on_peat_pct)) rows.push({ key: 'On peat %', val: fmt(props.on_peat_pct) });
            if (fmt(props.effective_mesh_size_ha)) rows.push({ key: 'Effective mesh size (ha)', val: fmt(props.effective_mesh_size_ha) });
            if (fmt(props.mean_nn_m)) rows.push({ key: 'Mean NN distance (m)', val: fmt(props.mean_nn_m) });
            if (fmt(props.num_patches)) rows.push({ key: 'Number of patches', val: fmt(props.num_patches) });
            // Patch distribution (same bands as national; omit ‚â§ 0.01 ha so LNRS matches national 0 ha)
            const bands = [
                { key: '0.01-0.1 ha', pct: props.pct_0_01_0_1, area: props.area_0_01_0_1_ha },
                { key: '0.1-1 ha', pct: props.pct_0_1_1, area: props.area_0_1_1_ha },
                { key: '1-5 ha', pct: props.pct_1_5, area: props.area_1_5_ha },
                { key: '5-10 ha', pct: props.pct_5_10, area: props.area_5_10_ha },
                { key: '‚â• 10 ha', pct: props.pct_gte_10, area: props.area_gte_10_ha }
            ];
            const hasPatchData = bands.some(b => (b.pct != null && b.pct !== '') || (b.area != null && b.area !== ''));
            if (hasPatchData) {
                rows.push({ divider: true });
                rows.push({ section: 'Patch Distribution' });
                bands.forEach(b => {
                    const pct = pctFmt(b.pct);
                    const areaHa = fmt(b.area);
                    const val = [pct ? pct + '%' : null, areaHa ? areaHa + ' ha' : null].filter(Boolean).join(' ‚Äî ');
                    if (val) rows.push({ key: b.key + ':', val });
                });
                const med = fmt(props.median_patch_ha);
                const large = fmt(props.largest_patch_ha);
                if (med || large) rows.push({ key: 'Median | Largest', val: [med ? med + ' ha' : '', large ? large + ' ha' : ''].filter(Boolean).join(' | ') });
            } else {
                if (fmt(props.largest_patch_ha)) rows.push({ key: 'Largest patch (ha)', val: fmt(props.largest_patch_ha) });
                if (fmt(props.median_patch_ha)) rows.push({ key: 'Median patch (ha)', val: fmt(props.median_patch_ha) });
            }
            // Suitability for restoration (ha by land value class) ‚Äî last section
            const s12 = props.suitable_ha_grade_12, s3 = props.suitable_ha_grade_3, s45 = props.suitable_ha_grade_45;
            if (s12 != null || s3 != null || s45 != null) {
                rows.push({ divider: true });
                rows.push({ section: 'Suitability for restoration' });
                if (fmt(s12) != null) rows.push({ key: 'Agricultural Grade 1‚Äì2 (ha)', val: fmt(s12) });
                if (fmt(s3) != null) rows.push({ key: 'Agricultural Grade 3 (ha)', val: fmt(s3) });
                if (fmt(s45) != null) rows.push({ key: 'Agricultural Grade 4‚Äì5 (ha)', val: fmt(s45) });
            }
            return rows;
        }

        function showPolygonPopup(object) {
            if (!object || !object.properties) return;
            const title = object.properties.Name || object.properties.LNRS_ID || 'Region';
            document.getElementById('polygon-popup-title').textContent = title;
            const body = document.getElementById('polygon-popup-body');
            body.innerHTML = formatPolygonPopup(object.properties)
                .map(r => {
                    if (r.divider) return `<hr class="popup-section-divider" />`;
                    if (r.section) return `<p class="polygon-popup-section">${r.section}</p>`;
                    return `<div class="attr-row"><strong class="attr-key">${r.key}</strong><span class="attr-val">${r.val}</span></div>`;
                })
                .join('');
            document.getElementById('polygon-popup').classList.add('visible');
        }

        function hidePolygonPopup() {
            document.getElementById('polygon-popup').classList.remove('visible');
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('btn-hexagons').classList.toggle('active', mode === 'hexagons');
            document.getElementById('btn-polygons').classList.toggle('active', mode === 'polygons');
            document.getElementById('btn-potential').classList.toggle('active', mode === 'potential');
            document.getElementById('controls').style.display = mode === 'hexagons' ? 'block' : 'none';
            document.getElementById('legend').style.display = 'block';
            const legendTitle = document.getElementById('legend-title');
            const hasLandValueClasses = potentialPoints && potentialPoints.length > 0 && potentialPoints[0].length === 4;
            const lvNames = ['Grade 1‚Äì2', 'Grade 3', 'Grade 4‚Äì5'];
            if (mode === 'hexagons') {
                legendTitle.textContent = 'Wet Woodland Density';
                document.getElementById('landvalue-toggle').style.display = 'none';
            } else if (mode === 'polygons') {
                legendTitle.textContent = 'Wet woodland area (ha)';
                document.getElementById('landvalue-toggle').style.display = 'none';
            } else {
                legendTitle.textContent = hasLandValueClasses
                    ? 'Restoration suitability ‚Äî ' + lvNames[potentialLandValueClass]
                    : 'Restoration suitability (0.15 ‚Äì 1)';
                const lvToggle = document.getElementById('landvalue-toggle');
                lvToggle.style.display = hasLandValueClasses ? 'flex' : 'none';
                if (hasLandValueClasses) {
                    document.getElementById('lv-12').classList.toggle('active', potentialLandValueClass === 0);
                    document.getElementById('lv-3').classList.toggle('active', potentialLandValueClass === 1);
                    document.getElementById('lv-45').classList.toggle('active', potentialLandValueClass === 2);
                }
            }
            document.getElementById('info').style.display = mode === 'hexagons' ? 'block' : 'none';
            if (mode === 'polygons') hidePolygonPopup();
            updateLayers();
        }

        function getLayers() {
            if (viewMode === 'hexagons' && hexagonData) {
                const filteredFeatures = hexagonData.features.filter(f =>
                    f.properties.count > minPixelCount && f.properties.count <= maxPixelCount
                );
                return [new deck.GeoJsonLayer({
                    id: 'wet-woodland-hexagons',
                    data: { type: 'FeatureCollection', features: filteredFeatures },
                    opacity: layerOpacity,
                    stroked: true,
                    filled: true,
                    extruded: true,
                    wireframe: false,
                    lineWidthMinPixels: 0.5,
                    material: { ambient: 0.35, diffuse: 0.6, shininess: 32, specularColor: [60, 60, 60] },
                    getElevation: f => Math.pow(f.properties.count, heightExponent) * 50,
                    getFillColor: f => densityToColor(f.properties.count, minCount, maxCount),
                    getLineColor: [80, 80, 80, 100],
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 100]
                })];
            }
            if (viewMode === 'polygons' && polygonData) {
                return [new deck.GeoJsonLayer({
                    id: 'wet-woodland-lnrs-regions',
                    data: polygonData,
                    stroked: true,
                    filled: true,
                    extruded: false,
                    getFillColor: f => densityToColor(f.properties.total_area_ha ?? 0, polygonMinDensity, polygonMaxDensity, 128),
                    getLineColor: [0, 0, 0, 255],
                    lineWidthMinPixels: 1,
                    pickable: true,
                    autoHighlight: true,
                    highlightColor: [255, 255, 255, 80]
                })];
            }
            if (viewMode === 'potential' && potentialPoints && potentialPoints.length > 0) {
                const hasClass = potentialPoints[0].length === 4;
                const data = hasClass
                    ? potentialPoints.filter(d => d[3] === potentialLandValueClass)
                    : potentialPoints;
                if (data.length === 0) return [];
                return [new deck.HeatmapLayer({
                    id: 'potential-heatmap',
                    data: data,
                    getPosition: d => [d[0], d[1]],
                    getWeight: d => d[2],
                    radiusPixels: 25,
                    intensity: 1,
                    threshold: 0.03,
                    opacity: 0.85,
                    colorRange: DENSITY_COLOR_RANGE.map(c => [...c, 200])
                })];
            }
            return [];
        }

        function updateLayers() {
            if (deckgl) deckgl.setProps({ layers: getLayers() });
        }

        // Load hexagon data first, then init map
        fetch('wet_woodland_hexagons.geojson')
            .then(response => response.json())
            .then(data => {
                hexagonData = data;
                const counts = data.features.map(f => f.properties.count);
                maxCount = counts.reduce((a, b) => Math.max(a, b), 0);
                minCount = counts.reduce((a, b) => Math.min(a, b), Infinity);
                document.getElementById('loading').style.display = 'none';

                deckgl = new deck.DeckGL({
                    container: 'map',
                    mapLib: maplibregl,
                    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                    initialViewState: INITIAL_VIEW_STATE,
                    controller: true,
                    layers: getLayers(),
                    effects: [
                        new deck.LightingEffect({
                            ambient: { color: [255, 255, 255], intensity: 1.0 },
                            directional: [
                                { color: [255, 255, 255], intensity: 1.0, direction: [-3, -9, -1] },
                                { color: [255, 255, 255], intensity: 0.5, direction: [1, 3, 8] }
                            ]
                        })
                    ],
                    parameters: { clearColor: [0.07, 0.14, 0.19, 1] },
                    getTooltip: ({ object }) => {
                        if (!object) return null;
                        if (viewMode === 'hexagons' && object.properties.count != null) {
                            const count = object.properties.count;
                            const hectares = (count * 0.01).toFixed(2);
                            return { html: `<div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;"><strong>Wet Woodland:</strong> ${count.toLocaleString()} pixels<br><strong>Area:</strong> ${hectares} ha</div>`, style: { fontSize: '12px', color: 'white' } };
                        }
                        if (viewMode === 'polygons' && object.properties) {
                            const name = object.properties.Name || object.properties.LNRS_ID || 'Region';
                            return { html: `<div style="background: rgba(0,0,0,0.9); padding: 10px; border-radius: 5px;"><strong>${name}</strong><br>Click for details</div>`, style: { fontSize: '12px', color: 'white' } };
                        }
                        return null;
                    },
                    onClick: ({ object }) => {
                        if (viewMode === 'polygons' && object && object.properties) showPolygonPopup(object);
                    }
                });

                const updateVisualization = () => deckgl.setProps({ layers: getLayers() });

                document.getElementById('height-slider').addEventListener('input', (e) => {
                    heightExponent = parseFloat(e.target.value) / 10;
                    document.getElementById('height-value').textContent = heightExponent.toFixed(1) + 'x';
                    updateVisualization();
                });
                document.getElementById('opacity-slider').addEventListener('input', (e) => {
                    layerOpacity = parseFloat(e.target.value) / 100;
                    document.getElementById('opacity-value').textContent = layerOpacity.toFixed(2);
                    updateVisualization();
                });
                document.getElementById('min-count-slider').addEventListener('input', (e) => {
                    minPixelCount = parseInt(e.target.value);
                    document.getElementById('min-count-value').textContent = '>' + minPixelCount;
                    updateVisualization();
                });
                const maxCountSlider = document.getElementById('max-count-slider');
                const maxCountValue = document.getElementById('max-count-value');
                maxCountSlider.max = maxCount;
                maxCountSlider.value = maxCount;
                maxCountSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    maxPixelCount = value >= maxCount ? Infinity : value;
                    maxCountValue.textContent = maxPixelCount === Infinity ? 'No limit' : '‚â§' + maxPixelCount;
                    updateVisualization();
                });

                document.getElementById('btn-hexagons').addEventListener('click', () => setViewMode('hexagons'));
                document.getElementById('btn-polygons').addEventListener('click', () => {
                    if (polygonData) {
                        setViewMode('polygons');
                    } else {
                        document.getElementById('loading').style.display = 'block';
                        document.getElementById('loading').textContent = 'Loading LNRS regions...';
                        fetch('wet_woodland_lnrs_regions.geojson')
                            .then(r => r.json())
                            .then(geo => {
                                polygonData = geo;
                                const densities = geo.features.map(f => f.properties.total_area_ha ?? 0);
                                polygonMinDensity = densities.length ? Math.min(...densities) : 0;
                                polygonMaxDensity = densities.length ? Math.max(...densities) : 1;
                                if (polygonMaxDensity === polygonMinDensity) polygonMaxDensity = polygonMinDensity + 1;
                                document.getElementById('loading').style.display = 'none';
                                setViewMode('polygons');
                            })
                            .catch(err => {
                                console.error(err);
                                document.getElementById('loading').innerHTML = '‚ùå Error loading regions.';
                            });
                    }
                });
                document.getElementById('btn-potential').addEventListener('click', () => {
                    if (potentialPoints) {
                        setViewMode('potential');
                    } else {
                        document.getElementById('loading').style.display = 'block';
                        document.getElementById('loading').textContent = 'Loading potential layer...';
                        const loadPotential = (points) => {
                            potentialPoints = points;
                            document.getElementById('loading').style.display = 'none';
                            setViewMode('potential');
                        };
                        fetch('potential_points.bin')
                            .then(r => r.ok ? r.arrayBuffer() : Promise.reject(new Error('no bin')))
                            .then(buf => {
                                const f32 = new Float32Array(buf);
                                // 16 bytes/point = 4 floats (with land class); 12 bytes = 3 floats
                                const nFloats = f32.length;
                                const isClass = (v) => v >= 0 && v <= 2 && (v === 0 || v === 1 || v === 2 || Math.abs(v - Math.round(v)) < 1e-5);
                                let is4Value = nFloats >= 4 && isClass(f32[3]);
                                if (!is4Value && nFloats >= 16) {
                                    const c1 = f32[3], c2 = f32[7], c3 = f32[11];
                                    if (isClass(c1) && isClass(c2) && isClass(c3)) is4Value = true;
                                }
                                const stride = is4Value ? 4 : 3;
                                const points = [];
                                for (let i = 0; i < f32.length; i += stride) {
                                    if (stride === 4) points.push([f32[i], f32[i+1], f32[i+2], f32[i+3]]);
                                    else points.push([f32[i], f32[i+1], f32[i+2]]);
                                }
                                return points;
                            })
                            .then(loadPotential)
                            .catch(() => fetch('potential_points.json').then(r => r.json()).then(loadPotential))
                            .catch(err => {
                                console.error(err);
                                document.getElementById('loading').innerHTML = '‚ùå Missing potential layer. Run: python raster_potential_to_points.py --raster data/wet_woodland_potential.tif --output docs/potential_points.json';
                            });
                    }
                });
                const lvNames = ['Grade 1‚Äì2', 'Grade 3', 'Grade 4‚Äì5'];
                document.getElementById('lv-12').addEventListener('click', () => {
                    potentialLandValueClass = 0;
                    if (viewMode === 'potential') {
                        document.getElementById('legend-title').textContent = 'Restoration suitability ‚Äî ' + lvNames[0];
                        document.getElementById('lv-12').classList.add('active');
                        document.getElementById('lv-3').classList.remove('active');
                        document.getElementById('lv-45').classList.remove('active');
                        updateLayers();
                    }
                });
                document.getElementById('lv-3').addEventListener('click', () => {
                    potentialLandValueClass = 1;
                    if (viewMode === 'potential') {
                        document.getElementById('legend-title').textContent = 'Restoration suitability ‚Äî ' + lvNames[1];
                        document.getElementById('lv-3').classList.add('active');
                        document.getElementById('lv-12').classList.remove('active');
                        document.getElementById('lv-45').classList.remove('active');
                        updateLayers();
                    }
                });
                document.getElementById('lv-45').addEventListener('click', () => {
                    potentialLandValueClass = 2;
                    if (viewMode === 'potential') {
                        document.getElementById('legend-title').textContent = 'Restoration suitability ‚Äî ' + lvNames[2];
                        document.getElementById('lv-45').classList.add('active');
                        document.getElementById('lv-12').classList.remove('active');
                        document.getElementById('lv-3').classList.remove('active');
                        updateLayers();
                    }
                });
                document.getElementById('close-polygon-popup').addEventListener('click', hidePolygonPopup);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
